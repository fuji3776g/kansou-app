<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>æ„Ÿæƒ³ãƒ¡ãƒ¼ã‚«ãƒ¼ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆï½œå†…çœæ”¯æ´</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c:wght@400;500;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --teal-50:#f0fdfa; --teal-100:#ccfbf1; --teal-200:#99f6e4; --teal-300:#5eead4; --teal-400:#2dd4bf; --teal-500:#14b8a6; --teal-600:#0d9488; --teal-700:#0f766e; --teal-800:#115e59; --teal-900:#134e4a;
    }
    body { font-family: 'M PLUS Rounded 1c', system-ui, -apple-system, Segoe UI, Roboto, 'Helvetica Neue', Arial, 'Noto Sans JP', sans-serif; background: var(--teal-50); color:#0f172a; }
    .card { background:#fff; border:1px solid var(--teal-100); border-radius:1rem; box-shadow:0 6px 16px rgba(0,0,0,.05); }
    .bubble { max-width: 80%; border-radius: 1rem; padding:.75rem 1rem; box-shadow:0 2px 8px rgba(0,0,0,.06) }
    .bubble-teacher { background:#ffffff; border:1px solid var(--teal-100); }
    .bubble-student { background:#e6fffb; border:1px solid var(--teal-200); }
    .loader { border:4px solid var(--teal-100); border-top:4px solid var(--teal-500); border-radius:50%; width:32px; height:32px; animation:spin 1s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg);} }
    .fade-in { animation: fade .28s ease-out both; }
    @keyframes fade { from { opacity:0; transform: translateY(6px);} to{ opacity:1; transform:none;} }
  </style>
</head>
<body>
  <main class="mx-auto max-w-3xl p-4 md:p-8">
    <header class="text-center mb-6 md:mb-8">
      <h1 class="text-2xl md:text-4xl font-bold text-teal-800">æ„Ÿæƒ³ãƒ¡ãƒ¼ã‚«ãƒ¼ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ âœï¸</h1>
      <p class="text-teal-700 mt-2">AIã«ç­”ãˆã‚’èãã®ã§ã¯ãªãã€è‡ªåˆ†ã§å•ã„ã‚’ç«‹ã¦ã¦è€ƒãˆã‚’æ·±ã‚ã‚‹å­¦ã³ç”¨ãƒ„ãƒ¼ãƒ«</p>
    </header>

    <!-- è¨­å®šãƒ‘ãƒãƒ« -->
    <section class="card p-4 md:p-6 mb-6">
      <div class="grid gap-4 md:grid-cols-3">
        <label class="block md:col-span-3">
          <span class="text-sm font-semibold text-teal-800">å…ˆç”Ÿã‚’é¸ã¶</span>
          <div id="personaGroup" class="mt-2 flex flex-wrap gap-2">
            <label><input type="radio" name="persona" value="ç†±è¡€å…ˆç”Ÿ" checked> ç†±è¡€å…ˆç”Ÿ</label>
            <label><input type="radio" name="persona" value="ãƒãƒŠãƒãƒ«å…ˆç”Ÿ"> ãƒãƒŠãƒãƒ«å…ˆç”Ÿ</label>
            <label><input type="radio" name="persona" value="ãƒ”ã‚·ãƒƒã¨å…ˆç”Ÿ"> ãƒ”ã‚·ãƒƒã¨å…ˆç”Ÿ</label>
            <label><input type="radio" name="persona" value="ãƒ¦ãƒ¼ãƒ¢ã‚¢å…ˆç”Ÿ"> ãƒ¦ãƒ¼ãƒ¢ã‚¢å…ˆç”Ÿ</label>
            <label><input type="radio" name="persona" value="ã˜ã£ãã‚Šå…ˆç”Ÿ"> ã˜ã£ãã‚Šå…ˆç”Ÿ</label>
          </div>
        </label>
        <label class="block md:col-span-3 mt-4">
          <span class="text-sm font-semibold text-teal-800">æˆæ¥­åï¼ˆä»»æ„ï¼‰</span>
          <input id="lesson" type="text" placeholder="ä¾‹ï¼šç”ŸæˆAIç ”ä¿®" class="mt-1 w-full rounded-lg border border-teal-200 bg-white px-3 py-2 focus:outline-none focus:ring-2 focus:ring-teal-500" />
        </label>
      </div>
      <div class="mt-3 flex flex-wrap items-center gap-2">
        <span class="inline-flex items-center gap-2 rounded-full border border-teal-200 bg-white px-3 py-1 text-sm text-teal-800">
          ğŸ”„ 3ã¤ã®è³ªå• â†’ 4ã¤ç›®ã§æ„Ÿæƒ³ã®ãƒ’ãƒ³ãƒˆ
        </span>
        <span class="inline-flex items-center gap-2 rounded-full border border-teal-200 bg-white px-3 py-1 text-sm text-teal-800">
          âœ… ä¾‹æ–‡ãªã—ï¼è³ªå•ã ã‘ï¼‹åŠ±ã¾ã—
        </span>
      </div>
    </section>

    <!-- é€²æ—è¡¨ç¤º -->
    <section class="mb-4 flex items-center justify-between">
      <div class="flex items-center gap-2 text-teal-800">
        <span class="font-bold">é€²æ—</span>
        <div class="w-40 h-2 bg-white border border-teal-100 rounded-full overflow-hidden">
          <div id="bar" class="h-full bg-teal-500" style="width:0%"></div>
        </div>
        <span id="stepLabel" class="text-sm">0 / 3</span>
      </div>
      <div class="flex gap-2">
        <button id="resetBtn" class="rounded-full border border-teal-200 bg-white px-3 py-1 text-sm text-teal-700 hover:bg-teal-50">ãƒªã‚»ãƒƒãƒˆ</button>
        <button id="exportBtn" class="rounded-full bg-teal-600 px-3 py-1 text-sm font-semibold text-white hover:bg-teal-700">ãƒ’ãƒ³ãƒˆã‚’ã‚³ãƒ”ãƒ¼</button>
      </div>
    </section>

    <!-- ãƒãƒ£ãƒƒãƒˆé ˜åŸŸ -->
    <section id="chat" class="card p-4 md:p-6 min-h-[340px]">
      <ul id="log" class="space-y-3"></ul>
      <div id="loader" class="hidden justify-center mt-4">
        <div class="loader"></div>
      </div>

      <div id="hintWrap" class="hidden mt-4 border-t border-teal-100 pt-4">
        <h2 class="text-teal-800 font-bold mb-2">ğŸ§­ æ„Ÿæƒ³ã®ãƒ’ãƒ³ãƒˆ</h2>
        <textarea id="hint" class="w-full min-h-[120px] rounded-lg border border-teal-200 p-3 focus:outline-none focus:ring-2 focus:ring-teal-500" readonly></textarea>
        <p class="text-xs text-teal-700 mt-2">â€» ãƒ’ãƒ³ãƒˆã¯ã‚ãªãŸã®è¨€è‘‰ã‚’ã‚‚ã¨ã«ã—ãŸæ›¸ãæ–¹ã®å‹ã€‚ã“ã®ã¾ã¾å†™ã™ã®ã§ã¯ãªãã€è‡ªåˆ†ã®è¨€è‘‰ã§ä»•ä¸Šã’ã‚‹ã“ã¨ã€‚</p>
        <p class="text-sm text-center text-teal-800 font-semibold mt-2">ğŸ‘‰ ã‚¯ãƒ©ã‚¹ãƒ«ãƒ¼ãƒ ã«ã‚³ãƒ”ãƒšã—ã¦æ„Ÿæƒ³æ¬„ã«è²¼ã£ã¦ã­</p>
      </div>

      <div class="mt-4 flex items-end gap-2">
        <textarea id="input" rows="2" class="flex-1 rounded-lg border border-teal-200 p-3 focus:outline-none focus:ring-2 focus:ring-teal-500" placeholder="ã“ã“ã«ä¸‹æ›¸ãâ†’ã‚¯ãƒ©ã‚¹ãƒ«ãƒ¼ãƒ ã«ã‚³ãƒ”ãƒšã‚’"></textarea>
        <button id="send" class="rounded-full bg-teal-600 px-5 py-3 font-bold text-white hover:bg-teal-700">é€ä¿¡</button>
      </div>
    </section>

    <footer class="text-center text-xs text-slate-500 mt-6">Â© 2025 Reflective Learning Toolkit</footer>
  </main>

  <script>
    const logEl = document.getElementById('log');
    const inputEl = document.getElementById('input');
    const sendBtn = document.getElementById('send');
    const resetBtn = document.getElementById('resetBtn');
    const exportBtn = document.getElementById('exportBtn');
    const hintWrap = document.getElementById('hintWrap');
    const hintEl = document.getElementById('hint');
    const barEl = document.getElementById('bar');
    const stepLabelEl = document.getElementById('stepLabel');
    const lessonEl = document.getElementById('lesson');
    const loaderEl = document.getElementById('loader');

    const state = { step: 0, history: [] };
    const API_URL = "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=";
    const apiKey = ""; // APIã‚­ãƒ¼ã¯Canvasã«ã‚ˆã£ã¦è‡ªå‹•çš„ã«æä¾›ã•ã‚Œã¾ã™

    // ãƒãƒ£ãƒƒãƒˆãƒãƒ–ãƒ«ã‚’è¿½åŠ ã™ã‚‹é–¢æ•°
    function addBubble(role, text) {
      const li = document.createElement('li');
      li.className = 'fade-in flex ' + (role === 'teacher' ? 'justify-start' : 'justify-end');
      const bubble = document.createElement('div');
      bubble.className = 'bubble ' + (role === 'teacher' ? 'bubble-teacher' : 'bubble-student');
      bubble.innerText = text;
      li.appendChild(bubble);
      logEl.appendChild(li);
      logEl.scrollTop = logEl.scrollHeight;
      state.history.push({ role, text });
    }

    // é€²æ—ãƒãƒ¼ã‚’æ›´æ–°ã™ã‚‹é–¢æ•°
    function updateProgress() {
      const pct = Math.min(state.step, 3) / 3 * 100;
      barEl.style.width = pct + '%';
      stepLabelEl.textContent = `${Math.min(state.step, 3)} / 3`;
    }

    // å…¥åŠ›ã¨ãƒœã‚¿ãƒ³ã®çŠ¶æ…‹ã‚’ç®¡ç†ã™ã‚‹é–¢æ•°
    function setUIState(enabled) {
      inputEl.disabled = !enabled;
      sendBtn.disabled = !enabled;
      if (enabled) {
        loaderEl.classList.add('hidden');
        inputEl.focus();
      } else {
        loaderEl.classList.remove('hidden');
      }
    }

    // å…ˆç”Ÿã®ãƒšãƒ«ã‚½ãƒŠã‚’å–å¾—ã™ã‚‹é–¢æ•°
    function getPersona() {
      const checked = document.querySelector('input[name="persona"]:checked');
      return checked ? checked.value : 'ç†±è¡€å…ˆç”Ÿ';
    }

    // APIã‚’å‘¼ã³å‡ºã—ã¦ã€è³ªå•ã‚„ãƒ’ãƒ³ãƒˆã‚’ç”Ÿæˆã™ã‚‹é–¢æ•°
    async function fetchGeminiResponse(prompt) {
      setUIState(false); // UIã‚’ç„¡åŠ¹åŒ–
      let retries = 0;
      const maxRetries = 5;
      const initialDelay = 1000;

      while (retries < maxRetries) {
        try {
          // APIã«æ¸¡ã™ãŸã‚ã®ãƒãƒ£ãƒƒãƒˆå±¥æ­´ã‚’ä½œæˆ
          const chatHistory = state.history.map(entry => ({
            role: entry.role === 'teacher' ? 'model' : 'user',
            parts: [{ text: entry.text }]
          }));

          // æ–°ã—ã„ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’è¿½åŠ 
          chatHistory.push({ role: 'user', parts: [{ text: prompt }] });

          const payload = {
            contents: chatHistory
          };

          const response = await fetch(API_URL + apiKey, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
          });

          if (!response.ok) {
            if (response.status === 429) {
              const delay = initialDelay * Math.pow(2, retries);
              console.warn(`API Rate limit exceeded. Retrying in ${delay / 1000}s...`);
              await new Promise(res => setTimeout(res, delay));
              retries++;
              continue;
            }
            throw new Error(`API error: ${response.status}`);
          }

          const result = await response.json();
          if (result.candidates && result.candidates.length > 0 &&
              result.candidates[0].content && result.candidates[0].content.parts &&
              result.candidates[0].content.parts.length > 0) {
            return result.candidates[0].content.parts[0].text;
          } else {
            console.error('Unexpected API response structure:', result);
            return 'ã”ã‚ã‚“ãªã•ã„ã€ã†ã¾ãè€ƒãˆã‚‰ã‚Œãªã‹ã£ãŸã¿ãŸã„ã€‚ã‚‚ã†ä¸€åº¦è©¦ã—ã¦ãã‚Œã‚‹ï¼Ÿ';
          }
        } catch (error) {
          console.error('API call failed:', error);
          if (retries < maxRetries - 1) {
            const delay = initialDelay * Math.pow(2, retries);
            await new Promise(res => setTimeout(res, delay));
            retries++;
          } else {
            return 'ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚æ™‚é–“ã‚’ç½®ã„ã¦ã‹ã‚‰ãŠè©¦ã—ãã ã•ã„ã€‚';
          }
        }
      }
    }

    // é€ä¿¡ãƒœã‚¿ãƒ³ã®ãƒãƒ³ãƒ‰ãƒ©ãƒ¼
    async function handleSend() {
      const text = (inputEl.value || '').trim();
      if (!text) {
        inputEl.focus();
        return;
      }
      addBubble('student', text);
      inputEl.value = '';

      const persona = getPersona();
      let geminiResponse;

      // ã‚¹ãƒ†ãƒƒãƒ—ã”ã¨ã«ç•°ãªã‚‹ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ä½œæˆã—ã¦APIã‚’å‘¼ã³å‡ºã™
      if (state.step < 3) {
        const questionPrompt = `ã‚ãªãŸã¯ã€Œ${persona}ã€ã§ã™ã€‚ç”Ÿå¾’ã®æ„Ÿæƒ³ã‚’æ·±ã‚ã‚‹ãŸã‚ã®ã€æ¬¡ã®è³ªå•ã‚’æ—¥æœ¬èªã§1ã¤ã ã‘ä½œæˆã—ã¦ãã ã•ã„ã€‚ä¾‹ã‚„ä¾‹æ–‡ã€ä½™è¨ˆãªèª¬æ˜ã¯å«ã‚ãšã€è³ªå•ã¨åŠ±ã¾ã—ã®è¨€è‘‰ã ã‘ã«ã—ã¦ãã ã•ã„ã€‚`;
        geminiResponse = await fetchGeminiResponse(questionPrompt);

        if (geminiResponse) {
          state.step++;
          updateProgress();
          addBubble('teacher', geminiResponse);
        }
      }

      // æœ€å¾Œã®ã‚¹ãƒ†ãƒƒãƒ—ã§ãƒ’ãƒ³ãƒˆã‚’ç”Ÿæˆ
      if (state.step === 3) {
        const hintPrompt = `ã“ã‚Œã¾ã§ã®ä¼šè©±ã‚’å‚è€ƒã«ã€ç”Ÿå¾’ãŒæ„Ÿæƒ³æ–‡ã‚’ã¾ã¨ã‚ã‚‹ãŸã‚ã®ãƒ’ãƒ³ãƒˆã‚’ã€ä»¥ä¸‹ã®ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã§ä½œæˆã—ã¦ãã ã•ã„ã€‚
        
        ã€æ„Ÿæƒ³ã®å‹ã€‘
        â‘  å°è±¡ã«æ®‹ã£ãŸã“ã¨ï¼š
        â‘¡ ã‚‚ã£ã¨çŸ¥ã‚ŠãŸã„ã¨æ€ã£ãŸã“ã¨ï¼š
        â‘¢ ãªã‚‹ã»ã©ã¨æ€ã£ãŸã“ã¨ï¼š
        â‘£ æ°—ã¥ãã®ã¾ã¨ã‚ï¼š
        â‘¤ æ¬¡ã®ä¸€æ­©ï¼š

        ãŸã ã—ã€ä¾‹æ–‡ã‚„å…·ä½“çš„ãªå†…å®¹ã¯æ›¸ã‹ãšã«ã€ç”Ÿå¾’ã®è¨€è‘‰ã‚’å…ƒã«ã—ãŸæŠ½è±¡çš„ãªå‹ï¼ˆä¾‹ï¼šã€Œã‚ãªãŸã®è¨€è‘‰ã€ã€‡ã€‡ã€ã€â–³â–³ã€ã‚’æ‰‹ãŒã‹ã‚Šã«æ·±ã‚ã‚ˆã†ã€ãªã©ï¼‰ã‚’æç¤ºã—ã¦ãã ã•ã„ã€‚`;
        
        geminiResponse = await fetchGeminiResponse(hintPrompt);
        
        if (geminiResponse) {
          hintEl.value = geminiResponse;
          hintWrap.classList.remove('hidden');
          addBubble('teacher', 'ã“ã“ã¾ã§ã®è€ƒãˆã€ã¨ã¦ã‚‚è‰¯ã„ã­ã€‚ä»•ä¸Šã’ã«å½¹ç«‹ã¤ãƒ’ãƒ³ãƒˆã‚’ç”¨æ„ã—ãŸã‚ˆã€‚');
        }
      }
      setUIState(true); // UIã‚’æœ‰åŠ¹åŒ–
    }

    // ã‚¢ãƒ—ãƒªã‚’åˆæœŸçŠ¶æ…‹ã«æˆ»ã™é–¢æ•°
    function start() {
      logEl.innerHTML = '';
      hintWrap.classList.add('hidden');
      hintEl.value = '';
      state.step = 0;
      state.history = [];
      updateProgress();
      addBubble('teacher', 'æˆæ¥­ã®æ„Ÿæƒ³ã‚’æ•™ãˆã¦ãã ã•ã„ã€‚');
      setUIState(true);
    }

    // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã®è¨­å®š
    sendBtn.addEventListener('click', handleSend);
    inputEl.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        handleSend();
      }
    });
    resetBtn.addEventListener('click', start);
    exportBtn.addEventListener('click', async () => {
      const text = hintEl.value.trim();
      if (!text) {
        addBubble('teacher', 'ã¾ãšã¯3ã¤ã®è³ªå•ã«ç­”ãˆã¦ã€ãƒ’ãƒ³ãƒˆã‚’å‡ºãã†ã€‚');
        return;
      }
      try {
        await navigator.clipboard.writeText(text);
        addBubble('teacher', 'ãƒ’ãƒ³ãƒˆã‚’ã‚³ãƒ”ãƒ¼ã—ãŸã‚ˆã€‚è‡ªåˆ†ã®è¨€è‘‰ã§ä»•ä¸Šã’ã‚ˆã†ã€‚');
      } catch {
        hintEl.focus();
        hintEl.select();
        addBubble('teacher', 'ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ãŒä½¿ãˆãªã„ç’°å¢ƒã ã‚ˆã€‚ãƒ’ãƒ³ãƒˆã‚’é¸æŠã—ã¦ã‚³ãƒ”ãƒ¼ã—ã¦ã­ã€‚');
      }
    });

    // ã‚¢ãƒ—ãƒªã®é–‹å§‹
    start();
  </script>
</body>
</html>
